name: weekly-agent

on:
  schedule:
    - cron: '0 1 * * MON'   # Coleta: Domingo 22:00 BRT (Segunda 01:00 UTC)
    - cron: '0 13 * * MON'  # Resumo/Envio: Segunda 10:00 BRT (13:00 UTC)
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 1 * * MON'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Instalar dependências
        run: |
          echo "openai==0.28.1" > requirements.txt
          echo "feedparser==6.0.11" >> requirements.txt
          echo "requests==2.32.3" >> requirements.txt
          pip install -r requirements.txt
      - name: Coletar notícias (últimos 7 dias)
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        run: |
          python agent_weekly.py --collect-only
      - name: Salvar artefato
        uses: actions/upload-artifact@v4
        with:
          name: collected
          path: collected.json

  summarize_and_send:
    runs-on: ubuntu-latest
    needs: collect
    if: github.event_name == 'schedule' && github.event.schedule == '0 13 * * MON'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Baixar artefato
        uses: actions/download-artifact@v4
        with:
          name: collected
      - name: Instalar dependências
        run: |
          pip install openai==0.28.1 feedparser==6.0.11 requests==2.32.3
      - name: Resumir e enviar por e-mail
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: |
          python agent_weekly.py --summarize-and-send collected.json
